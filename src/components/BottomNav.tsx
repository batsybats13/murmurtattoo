import { useLocation, useNavigate } from "react-router-dom";
import { useEffect, useRef, useMemo, useCallback } from "react";
import { useLanguage } from "../contexts/LanguageContext";

interface NavItemConfig {
  path: string;
  labelKey: string;
  icon: string;
  isStroke?: boolean;
  viewBox?: string;
}

const NAV_ITEMS: NavItemConfig[] = [
  {
    path: "/",
    labelKey: "nav.home",
    icon: "M83,79.8H17.1c-1.1,0-2-0.9-2-2V41.6c0-1.1,0.9-2,2-2h16.2c1.1,0,2,0.9,2,2v12.1h4.3v-22c0-1.1,0.9-2,2-2h16.2 c1.1,0,2,0.9,2,2v22h5.1V41.6c0-1.1,0.9-2,2-2H83c1.1,0,2,0.9,2,2v36.2C85,78.9,84.1,79.8,83,79.8z M19.1,75.8H81V43.6H68.8v12.1 c0,1.1-0.9,2-2,2h-9.1c-1.1,0-2-0.9-2-2v-22H43.6v22c0,1.1-0.9,2-2,2h-8.3c-1.1,0-2-0.9-2-2V43.6H19.1V75.8z M54.8,79.8h-9.6 c-1.1,0-2-0.9-2-2V65.3c0-1.1,0.9-2,2-2h9.6c1.1,0,2,0.9,2,2v12.6C56.8,78.9,55.9,79.8,54.8,79.8z M47.2,75.8h5.6v-8.6h-5.6V75.8z M30.1,66.4v-4.8c0-1.1-0.9-2-2-2s-2,0.9-2,2v4.8c0,1.1,0.9,2,2,2S30.1,67.5,30.1,66.4z M73.9,66.4v-4.8c0-1.1-0.9-2-2-2 s-2,0.9-2,2v4.8c0,1.1,0.9,2,2,2S73.9,67.5,73.9,66.4z M52,48.6v-4.8c0-1.1-0.9-2-2-2s-2,0.9-2,2v4.8c0,1.1,0.9,2,2,2 S52,49.7,52,48.6z M59.8,33.4H40.3c-1,0-1.9-0.6-2.3-1.4s-0.4-1.9,0.2-2.7c0,0,0,0,0,0l5.8-7.7l3.7-8.5c0.4-1,1.4-1.6,2.4-1.6 c0,0,0,0,0,0c1,0,2,0.6,2.4,1.6l3.7,8.7l5.7,7.6c0.6,0.8,0.7,1.8,0.2,2.7C61.6,32.8,60.7,33.4,59.8,33.4z M43.1,29.4H57l-4.1-5.5 c-0.1-0.2-0.2-0.4-0.3-0.5L50,17.5l-2.5,5.7c-0.1,0.2-0.2,0.4-0.3,0.5L43.1,29.4z M85,43.3H65.6c-1,0-1.9-0.6-2.3-1.4 c-0.4-0.9-0.4-1.9,0.2-2.7c0,0,0,0,0,0l5.8-7.7l3.7-8.5c0.4-1,1.4-1.6,2.4-1.6h0c1,0,2,0.6,2.4,1.6l3.7,8.7l5.7,7.6 c0.6,0.8,0.7,1.8,0.2,2.7S86,43.3,85,43.3z M68.3,39.3h13.9l-4.1-5.5c-0.1-0.2-0.2-0.3-0.3-0.5l-2.5-5.8l-2.5,5.7 c-0.1,0.2-0.2,0.4-0.3,0.5L68.3,39.3z M34.4,43.3H15c-1,0-1.9-0.6-2.3-1.4c-0.4-0.9-0.4-1.9,0.2-2.7c0,0,0,0,0,0l5.8-7.7l3.7-8.5 c0.4-1,1.4-1.6,2.4-1.6c0,0,0,0,0,0c1,0,2,0.6,2.4,1.6l3.7,8.7l5.7,7.6c0.6,0.8,0.7,1.8,0.2,2.7S35.4,43.3,34.4,43.3z M17.8,39.3 h13.9l-4.1-5.5c-0.1-0.2-0.2-0.4-0.3-0.5l-2.5-5.8l-2.5,5.7c-0.1,0.2-0.2,0.4-0.3,0.5L17.8,39.3z M90.4,88.7H9.6c-1.1,0-2-0.9-2-2 v-3.9c0-3.8,3.1-6.8,6.8-6.8h71.2c3.8,0,6.8,3.1,6.8,6.8v3.9C92.4,87.8,91.5,88.7,90.4,88.7z M11.6,84.7h76.9v-1.9 c0-1.6-1.3-2.8-2.8-2.8H14.4c-1.6,0-2.8,1.3-2.8,2.8V84.7z",
    isStroke: false,
    viewBox: "0 0 100 100",
  },
  {
    path: "/benefits",
    labelKey: "nav.benefits",
    icon: "M236.062,70.277c-11.115-5.777-23.436-7.583-36.618-5.369c-15.044,2.527-29.146,9.812-40.501,15.676 c-3.835,1.979-7.455,3.851-10.721,5.336c-1.468,0.67-2.826,1.112-4.044,1.317c-2.854,0.479-4.845-0.327-6.083-2.462 c-3.323-5.721-3.104-19.211,4.01-26.125c0.508-0.493,0.508-1.304-0.003-1.846c-0.499-0.527-1.356-0.626-1.928-0.197 c-1.915,1.441-4.288,2.432-6.863,2.865c-4.495,0.754-9.191-0.227-12.559-2.626c-2.737-1.952-4.427-4.716-4.884-7.995 c-0.101-0.732-0.804-1.284-1.563-1.23c-0.775,0.054-1.314,0.692-1.232,1.424c0.65,5.78-2.178,25.02-11.104,29.953 c-2.06,1.138-4.07-0.201-4.07-0.201c-3.197-2.016-7.639-10.04-8.135-10.948c-4.787-8.768-11.342-20.771-21.944-31.571 c-12.515-12.75-28.166-21.05-46.514-24.67c-0.714-0.141-1.404,0.272-1.583,0.916c-0.184,0.666,0.193,1.372,0.875,1.645 c4.573,1.825,13.094,7.328,16.022,16.37c2.313,7.139,0.471,14.763-5.474,22.658c-0.327,0.436-0.338,1.024-0.026,1.499 c0.311,0.477,0.875,0.735,1.439,0.661c11.13-1.461,15.726,2.577,17.298,6.364c4.879,11.759-2.65,15.871-2.65,15.871 c-0.643,0.356-0.858,0.923-0.669,1.536c0.195,0.629,0.826,1.059,1.498,1.021c10.236-0.571,30.378,9.618,43.107,21.803 c8.75,8.379,13.327,16.995,12.888,24.263c-0.039,0.63,0.378,1.213,1.015,1.418c0.621,0.201,1.313-0.046,1.621-0.566 c3.495-5.875,11.885-10.196,23.628-12.169c9.821-1.649,21.245-1.552,31.339,0.266c9.852,1.774,17.163,5.054,19.565,8.771 c0.363,0.565,1.104,0.827,1.741,0.596c0.637-0.229,0.979-0.868,0.813-1.521c-1.035-4.088-0.159-8.504,2.465-12.433 c2.859-4.277,7.401-7.307,12.154-8.105c3.127-0.525,6.163-0.091,9.021,1.288c0.488,0.236,1.09,0.185,1.501-0.134 c0.416-0.321,0.587-0.858,0.438-1.368c-1.408-4.818-0.403-10.246,2.828-15.289c4.567-7.125,12.757-12.45,21.37-13.897 c0.701-0.119,1.41-0.209,2.107-0.275c0.604-0.055,1.091-0.495,1.188-1.065C236.924,71.15,236.616,70.566,236.062,70.277z M140.965,127.705c-8.191,0.52-15.716,3.676-22.363,9.38c-7.586,6.509-13.035,15.37-17.421,22.502 c-1.482,2.408-2.88,4.684-4.209,6.622c-0.597,0.873-1.21,1.581-1.823,2.106c-1.44,1.235-2.829,1.457-4.247,0.678 c-3.801-2.085-8.243-9.729-6.592-16.016c0.118-0.449-0.156-0.904-0.626-1.035c-0.458-0.127-0.973,0.107-1.148,0.541 c-0.587,1.458-1.583,2.816-2.882,3.932c-2.267,1.943-5.234,2.982-7.935,2.775c-2.196-0.169-4.08-1.147-5.446-2.833 c-0.304-0.377-0.886-0.448-1.293-0.162c-0.417,0.293-0.503,0.833-0.21,1.217c2.321,3.022,7.245,14.775,3.906,20.564 c-0.771,1.335-2.352,1.265-2.352,1.265c-2.477-0.049-7.684-3.048-8.27-3.39c-5.653-3.299-13.394-7.816-22.997-10.288 c-11.338-2.919-22.929-2.279-34.449,1.899c-0.448,0.162-0.696,0.628-0.578,1.05c0.122,0.436,0.572,0.704,1.047,0.626 c3.184-0.523,9.827-0.319,14.531,3.763c3.713,3.225,5.26,8.125,4.597,14.566c-0.036,0.354,0.157,0.688,0.492,0.85 c0.336,0.163,0.74,0.117,1.032-0.116c5.75-4.587,9.696-3.876,11.86-2.282c6.717,4.946,3.884,9.802,3.884,9.802 c-0.24,0.417-0.169,0.809,0.145,1.088c0.322,0.287,0.822,0.315,1.186,0.066c5.551-3.785,20.301-4.885,31.567-2.355 c7.746,1.741,13.23,5.026,15.443,9.253c0.191,0.367,0.623,0.553,1.049,0.452c0.417-0.097,0.721-0.47,0.718-0.866 c-0.027-4.479,3.218-9.744,9.14-14.825c4.953-4.25,11.396-8.061,17.675-10.457c6.127-2.338,11.341-2.973,13.946-1.698 c0.396,0.193,0.9,0.09,1.18-0.255c0.278-0.346,0.255-0.819-0.059-1.13c-1.964-1.942-2.967-4.718-2.824-7.81 c0.157-3.368,1.681-6.604,4.077-8.662c1.577-1.353,3.428-2.137,5.497-2.33c0.354-0.033,0.674-0.266,0.797-0.583 c0.125-0.32,0.039-0.68-0.218-0.916c-2.42-2.227-3.693-5.612-3.587-9.536c0.151-5.543,2.944-11.303,7.288-15.029 c0.353-0.304,0.72-0.596,1.09-0.868c0.32-0.236,0.444-0.646,0.305-1C141.745,127.901,141.375,127.678,140.965,127.705z M220.366,205.274c-6.166-1.559-12.771-1.144-18.087-0.811c-1.795,0.111-3.491,0.219-4.986,0.239 c-0.673,0.01-1.266-0.05-1.764-0.177c-1.17-0.295-1.794-0.937-1.909-1.959c-0.309-2.741,2.038-7.853,5.912-9.298 c0.277-0.104,0.413-0.413,0.309-0.705c-0.102-0.285-0.413-0.467-0.702-0.397c-0.973,0.229-2.044,0.209-3.101-0.059 c-1.842-0.466-3.47-1.628-4.352-3.107c-0.718-1.204-0.899-2.543-0.523-3.871c0.084-0.296-0.092-0.625-0.39-0.732 c-0.307-0.108-0.618,0.044-0.71,0.336c-0.722,2.315-5.027,9.185-9.263,9.57c-0.977,0.089-1.52-0.76-1.52-0.76 c-0.882-1.307-1.232-5.113-1.27-5.542c-0.355-4.149-0.845-9.83-3.08-15.729c-2.638-6.966-7.22-12.758-13.614-17.218 c-0.249-0.173-0.582-0.131-0.758,0.084c-0.183,0.223-0.156,0.556,0.058,0.774c1.438,1.464,3.769,4.992,3.37,8.935 c-0.315,3.113-2.296,5.714-5.89,7.729c-0.197,0.112-0.301,0.335-0.261,0.568c0.039,0.234,0.21,0.427,0.438,0.494 c4.493,1.309,5.569,3.621,5.534,5.33c-0.11,5.307-3.674,5.613-3.674,5.613c-0.305,0.027-0.481,0.208-0.513,0.475 c-0.031,0.272,0.137,0.542,0.4,0.641c4.002,1.499,9.98,8.767,12.796,15.552c1.934,4.666,2.234,8.722,0.849,11.422 c-0.121,0.233-0.06,0.526,0.149,0.711c0.203,0.181,0.509,0.203,0.714,0.056c2.319-1.656,6.246-1.897,11.06-0.682 c4.025,1.018,8.368,2.971,11.916,5.356c3.462,2.329,5.703,4.809,5.996,6.63c0.044,0.277,0.283,0.502,0.564,0.521 s0.52-0.167,0.565-0.444c0.29-1.733,1.365-3.271,3.026-4.332c1.808-1.152,4.05-1.547,5.998-1.055 c1.282,0.324,2.368,0.999,3.226,2.004c0.147,0.172,0.387,0.253,0.597,0.201c0.213-0.053,0.367-0.229,0.396-0.449 c0.271-2.075,1.564-3.978,3.645-5.359c2.938-1.954,6.957-2.612,10.486-1.721c0.287,0.072,0.573,0.156,0.851,0.249 c0.239,0.08,0.5-0.006,0.632-0.208c0.135-0.206,0.115-0.479-0.048-0.683C230.169,209.396,225.771,206.64,220.366,205.274z",
    isStroke: false,
    viewBox: "0 0 236.844 236.844",
  },
  {
    path: "/styles",
    labelKey: "nav.styles",
    icon: "M197.023,225.545c-1.145-9.533-11.68-10.614-17.805-9.958c-6.521-24.554,16.225-61.151,17.563-69.82 c1.438-9.312-6.658-63.5-7.513-90.938C188.389,26.662,147.48-4.433,140.65,0.524c-6.768,7.484,9.748,17.585,1.054,26.245 c-8.398,8.367-10.588,13.99-16.824,23.46c-15.976,24.255,27.318,24.558,27.318,24.558s-33.882,25.112-41.421,37.768 c-6.943,11.656-9.854,24.696-18.232,35.688c-19.094,25.051-14.791,68.729-14.791,68.729s-36.17-11.839-16.264-53.133 C76.643,132.406,84.107,86.02,50.016,97.95c-13.189,4.616,2.949,14.325,5.734,17.435c9.318,10.4,1.441,27.896-4.174,38.012 c-15.037,27.091-20.496,55.475,11.154,72.978c14.063,7.776,33.055,9.7,52.17,9.982l48.64,0.14 C179.564,237.294,197.689,234.298,197.023,225.545z",
    isStroke: false,
    viewBox: "0 0 236.62 236.62",
  },
  {
    path: "/feed",
    labelKey: "nav.works",
    icon: "M229.415,51.874c-8.071-19.99-23.463-34.584-43.339-41.09c-7.198-2.355-14.739-3.551-22.413-3.551 c-15.957,0-32.041,5.191-46.026,14.746C103.651,12.424,87.567,7.232,71.61,7.232c-7.674,0-15.215,1.195-22.413,3.551 c-19.876,6.506-35.268,21.1-43.339,41.09c-7.85,19.439-7.809,41.752,0.114,62.83c15.593,41.475,96.401,104.273,105.593,111.32 c1.751,1.348,3.901,2.018,6.054,2.018c2.173,0,4.348-0.682,6.12-2.04c9.162-7.023,89.971-69.822,105.562-111.297 C237.225,93.625,237.266,71.313,229.415,51.874z M157.163,142.791c-8.278,4.145-7.896,13.097-7.896,13.097l0.014,13.785 c0,3.373-4.045,14.646-30.855,14.646c-0.271,0-0.525-0.009-0.788-0.01c-0.266,0.001-0.52,0.01-0.788,0.01 c-26.813,0-30.857-11.271-30.857-14.646l0.014-13.785c0,0,0.385-8.952-7.895-13.097c-17.352-8.686-15.163-27.64-15.163-38.817 c0-28.884,24.078-52.445,53.901-53.016c0.264,0.004,0.523,0.024,0.788,0.033c0.262-0.009,0.522-0.029,0.788-0.033 c22.938,0,40.254,18.1,40.254,18.1c8.491,9.336,13.646,21.556,13.646,34.916C172.326,115.152,174.516,134.106,157.163,142.791z",
    isStroke: false,
    viewBox: "0 0 235.273 235.273",
  },
  {
    path: "/booking",
    labelKey: "nav.booking",
    icon: "M7 5V3M17 5V3M10.799 11.286C9.47252 11.286 8.39715 10.2623 8.39715 9C6.59572 10.1432 6 12.7145 6 14.4849C6.19255 14.4481 6.39176 14.4287 6.59572 14.4287C7.62141 14.4287 8.52696 14.9181 9.06855 15.6649C9.37759 15.4278 9.77066 15.2858 10.1986 15.2858C11.1935 15.2858 12 16.0533 12 17C12 16.0533 12.8065 15.2858 13.8014 15.2858C14.2293 15.2858 14.6224 15.4278 14.9314 15.6649C15.473 14.9181 16.3786 14.4287 17.4043 14.4287C17.6082 14.4287 17.8075 14.4481 18 14.4849C18 12.7145 17.4043 10.1432 15.6034 9.00042C15.6034 10.2627 14.5275 11.286 13.201 11.286V9.00042L12.6005 10.1432H11.3995L10.799 9.00042V11.286ZM6.2 21H17.8C18.9201 21 19.4802 21 19.908 20.782C20.2843 20.5903 20.5903 20.2843 20.782 19.908C21 19.4802 21 18.9201 21 17.8V8.2C21 7.07989 21 6.51984 20.782 6.09202C20.5903 5.71569 20.2843 5.40973 19.908 5.21799C19.4802 5 18.9201 5 17.8 5H6.2C5.0799 5 4.51984 5 4.09202 5.21799C3.71569 5.40973 3.40973 5.71569 3.21799 6.09202C3 6.51984 3 7.07989 3 8.2V17.8C3 18.9201 3 19.4802 3.21799 19.908C3.40973 20.2843 3.71569 20.5903 4.09202 20.782C4.51984 21 5.07989 21 6.2 21Z",
    isStroke: true,
  },
];

export default function BottomNav() {
  const location = useLocation();
  const navigate = useNavigate();
  const navRef = useRef<HTMLElement>(null);
  const pillRef = useRef<HTMLDivElement>(null);
  const { t } = useLanguage();

  const isActive = useCallback(
    (path: string) => {
      if (path === "/") {
        return location.pathname === "/";
      }
      return location.pathname.startsWith(path);
    },
    [location.pathname]
  );

  const navItems = useMemo(
    () =>
      NAV_ITEMS.map((item) => ({
        ...item,
        label: item.labelKey ? t(item.labelKey) : "",
      })),
    [t]
  );

  useEffect(() => {
    if (!navRef.current || !pillRef.current) return;

    const updatePill = () => {
      const activeItem = navRef.current?.querySelector(
        ".nav-item.active"
      ) as HTMLElement;
      if (activeItem && pillRef.current && navRef.current) {
        requestAnimationFrame(() => {
          if (!activeItem || !pillRef.current || !navRef.current) return;

          const navRect = navRef.current.getBoundingClientRect();
          const itemRect = activeItem.getBoundingClientRect();

          // Используем полную ширину элемента включая padding
          const width = itemRect.width;
          const left = itemRect.left - navRect.left;

          pillRef.current.style.width = `${width}px`;
          pillRef.current.style.left = `${left}px`;
        });
      } else if (pillRef.current) {
        // Скрываем pill если нет активного элемента
        pillRef.current.style.width = "0px";
      }
    };

    // Обновляем сразу
    updatePill();

    // Обновляем после небольшой задержки для корректного расчета размеров
    const timeoutId = setTimeout(updatePill, 50);

    // Обновляем при изменении размера окна
    window.addEventListener("resize", updatePill);

    return () => {
      clearTimeout(timeoutId);
      window.removeEventListener("resize", updatePill);
    };
  }, [location.pathname]);

  return (
    <>
      {/* Защитный overlay для блокировки кликов на iframe под навигацией */}
      <div className="nav-protection-overlay" />
      <nav ref={navRef} className="bottom-nav-telegram">
        <div ref={pillRef} className="nav-pill" />
        {navItems.map((item) => (
          <a
            key={item.path}
            href={item.path}
            onClick={(e) => {
              e.preventDefault();
              navigate(item.path);
            }}
            className={`nav-item ${isActive(item.path) ? "active" : ""}`}
          >
            <span className="nav-item-icon">
              <svg
                width="22"
                height="22"
                viewBox={item.viewBox || "0 0 24 24"}
                fill={item.isStroke ? "none" : "currentColor"}
                stroke={
                  item.isStroke
                    ? "currentColor"
                    : item.path !== "/feed"
                    ? "rgba(0, 0, 0, 0.3)"
                    : "none"
                }
                strokeWidth={
                  item.isStroke ? "2" : item.path !== "/feed" ? "0.5" : "0"
                }
                strokeLinecap={item.isStroke ? "round" : "round"}
                strokeLinejoin={item.isStroke ? "round" : "round"}
                className="nav-icon-svg"
              >
                <path d={item.icon} />
                {item.path === "/feed" && (
                  <>
                    <ellipse cx="96.535" cy="99.596" rx="12.092" ry="14.601" />
                    <ellipse cx="117.638" cy="139.623" rx="8.938" ry="11.303" />
                    <ellipse cx="138.739" cy="99.596" rx="12.091" ry="14.601" />
                  </>
                )}
              </svg>
            </span>
            <span className="nav-item-label">{item.label}</span>
          </a>
        ))}
      </nav>
    </>
  );
}
